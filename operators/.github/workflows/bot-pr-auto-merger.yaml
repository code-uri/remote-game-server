# This workflow automatically merges pull requests opened by the bot
# after all status checks have passed.

name: Bot PR Auto-Merger

on:
  # Triggers when status checks on a PR are completed
  status: {}

jobs:
  auto-merge:
    # Only run if the status check was successful
    if: github.event.state == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Get PR metadata
        id: pr_meta
        uses: actions/github-script@v7
        with:
          script: |
            // Get all pull requests associated with the commit SHA
            const response = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha
            });
            const pr = response.data.length > 0 && response.data[0];
            if (!pr) {
              console.log('No PR found for this commit.');
              return;
            }
            // Expose the PR number and author as job outputs
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_author', pr.user.login);

      - name: Merge Bot PR
        # IMPORTANT: Only merge if a PR was found AND the author is your bot
        if: steps.pr_meta.outputs.pr_number && steps.pr_meta.outputs.pr_author == 'GitHub Actions Bot'
        env:
          # A PAT with repo scope is needed to merge
          GH_TOKEN: ${{ secrets.GPR_KEY }}
        run: |
          echo "All checks passed for PR #${{ steps.pr_meta.outputs.pr_number }} by ${{ steps.pr_meta.outputs.pr_author }}."
          echo "Attempting to merge..."
          gh pr merge ${{ steps.pr_meta.outputs.pr_number }} --merge --delete-branch
          echo "PR merged successfully."
