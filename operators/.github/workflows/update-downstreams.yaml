name: Propagate Dependency Updates

# This workflow runs whenever a new release is published in this repository.
on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  propagate-update:
    runs-on: ubuntu-latest
    steps:
      - name: 'Get release artifact and version'
        id: release_info
        run: |
          # This assumes your repo name matches the Maven artifactId.
          # You can make this logic more robust if needed.
          ARTIFACT_ID="${{ github.repository_owner }}/${{ github.event.repository.name }}"
          VERSION="${{ github.event.release.tag_name }}"
          # Strip 'v' prefix from tag if it exists (e.g., v1.5.0 -> 1.5.0)
          VERSION=${VERSION#v}
          echo "artifact_id=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
          echo "new_version=$VERSION" >> $GITHUB_OUTPUT

      - name: 'Define downstream repositories'
        id: downstream_repos
        run: |
          # This is a simple mapping. For a large system, you might
          # store this configuration in a central file.
          REPOS_JSON=""
          case "${{ steps.release_info.outputs.artifact_id }}" in
            "rad-tools")
              REPOS_JSON='["rgs-api", "money", "game-promotions", "games-supplier-integrations", "operator-integrations", "jackpot"]'
              ;;
            "money")
              REPOS_JSON='["rgs-api", "mock-pam", "game-promotions", "games-supplier-integrations", "operator-integrations", "jackpot"]'
              ;;
            "rgs-api")
              REPOS_JSON='["mock-pam", "game-promotions", "games-supplier-integrations", "operator-integrations"]'
              ;;
            *)
              REPOS_JSON='[]'
              ;;
          esac
          echo "repos=$REPOS_JSON" >> $GITHUB_OUTPUT

      - name: 'Check out, update, and create PRs for downstream repos'
        env:
          GH_TOKEN: ${{ secrets.GPR_KEY }}
          ARTIFACT_ID: ${{ steps.release_info.outputs.artifact_id }}
          NEW_VERSION: ${{ steps.release_info.outputs.new_version }}
          GPR_USER: ${{ secrets.GPR_USER }}
          GPR_KEY: ${{ secrets.GPR_KEY }}
        run: |
          # Loop through the JSON array of repository names
          for repo in $(echo '${{ steps.downstream_repos.outputs.repos }}' | jq -r '.[]'); do 
            echo "--- clone ${{ github.repository_owner }}/$repo ---"
            git clone "https://$GPR_USER:$GPR_KEY@github.com/${{ github.repository_owner }}/$repo.git"
            cd "$repo"

            # Use the Maven versions plugin for a safe update
            # mvn versions:use-new-version -Dincludes="in.aimlabs.gaming:$ARTIFACT_ID" -DnewVersion="$NEW_VERSION" -DgenerateBackupPoms=false            
            # For Gradle, you would typically update the build.gradle file directly.
            # This is a simplified example and might need adjustments based on your project structure.
            # You might need to parse the build.gradle file to find the correct dependency line.            
            # For Gradle, you would typically update the build.gradle file directly.
            # This is a simplified example and might need adjustments based on your project structure.
            # If versions are in gradle.properties, update that file.
            if [ -f "gradle.properties" ]; then
              echo "Updating gradle.properties for $ARTIFACT_ID to $NEW_VERSION"
              # Convert artifact ID to a property name (e.g., money -> MONEY_VERSION)
              PROPERTY_NAME=$(echo "$ARTIFACT_ID" | tr '[:lower:]' '[:upper:]' | tr '-' '_')_VERSION
              # This sed command should work on GNU sed (Linux). For macOS (BSD sed), you might need 'sed -i "" ...'
              echo "update $PROPERTY_NAME=$NEW_VERSION in $repo"
              sed -i "/^$PROPERTY_NAME=/c\\$PROPERTY_NAME=$NEW_VERSION" gradle.properties
            else
              echo "Neither gradle.properties nor build.gradle found for version update in $repo. Skipping."
              cd ..
              rm -rf "$repo"
              continue # Skip to the next repository
            fi

            # Check if the pom.xml was actually changed
            if ! git diff --quiet gradle.properties; then
              BRANCH_NAME="bot/update-$ARTIFACT_ID-to-$NEW_VERSION"
              git checkout -b "$BRANCH_NAME"
              git config user.name "GitHub Actions Bot"
              git config user.email "actions-bot@github.com"
              git add gradle.properties
              git commit -m "build: update $ARTIFACT_ID to v$NEW_VERSION"
              git push origin "$BRANCH_NAME"

              # Create a Pull Request
              gh pr create \
                --base main \
                --head "$BRANCH_NAME" \
                --title "build: Update $ARTIFACT_ID to v$NEW_VERSION" \
                --body "This PR was automatically generated to update the $ARTIFACT_ID dependency to the newly released version $NEW_VERSION."
            else
              echo "No update needed for $repo."
            fi
            cd ..
            rm -rf "$repo"
          done